# react-cropper-2 Context

## Project Overview

A modern React wrapper library for CropperJS 2.x (web components). This library provides TypeScript-first, React-friendly bindings for the CropperJS 2.x web component-based image cropping library.

## Architecture

### Core Components

1. **`<Cropper>` Component** (`src/components/Cropper.tsx`)
   - High-level React wrapper component
   - Declarative prop-based API
   - Forward ref with imperative handle
   - Full TypeScript support

2. **`useCropper` Hook** (`src/hooks/useCropper.ts`)
   - Composable React hook for advanced usage
   - Provides refs, state, and methods
   - Automatic event listener management
   - Cleanup on unmount

3. **Type Definitions** (`src/types/`)
   - TypeScript interfaces for all CropperJS elements
   - JSX namespace declarations for custom elements
   - Full type safety for props and events

## Key Technical Decisions

### 1. Web Components Integration
- Uses CropperJS 2.x custom elements (`<cropper-canvas>`, `<cropper-selection>`)
- JSX namespace declarations in `src/types/jsx.d.ts` for TypeScript support
- React refs to access underlying DOM elements

### 2. Event Handler Pattern
- **Critical:** Uses refs to store callbacks to prevent stale closures
- Pattern prevents memory leaks from re-attaching event listeners
- Example:
  ```typescript
  const onChangeRef = useRef(onChange);
  useEffect(() => { onChangeRef.current = onChange; });
  // Use onChangeRef.current in event listeners
  ```

### 3. Dual API Design
- **Component API:** Simple, declarative usage for common cases
- **Hook API:** Composable, flexible for advanced scenarios
- Both share the same underlying logic

### 4. Build Configuration
- Dual output: ES Modules + CommonJS
- Vite for bundling
- TypeScript declarations with source maps
- Tree-shakable (sideEffects: false)

## Development Workflow

### Test-Driven Development (TDD)
1. Write failing tests first
2. Implement minimal code to pass
3. Refactor for quality
4. All 49 tests must pass

### Code Quality Standards
- TypeScript strict mode (all strict flags enabled)
- ESLint with React + TypeScript rules
- Prettier for formatting
- 0 warnings, 0 errors

### Testing Stack
- Vitest - Test runner
- React Testing Library - Component testing
- @testing-library/jest-dom - DOM assertions

## Important Patterns

### Refs and Effects
```typescript
// ✅ CORRECT - Use refs for callbacks in effects
const callbackRef = useRef(callback);
useEffect(() => { callbackRef.current = callback; });

useEffect(() => {
  if (callbackRef.current) {
    callbackRef.current(data);
  }
}, [dependency]); // Callback NOT in deps

// ❌ WRONG - Callback in deps causes re-runs
useEffect(() => {
  if (callback) {
    callback(data);
  }
}, [callback, dependency]);
```

### Component Structure
```typescript
// 1. Props destructuring
// 2. Refs for DOM elements
// 3. Refs for callback storage
// 4. Effect to sync callback refs
// 5. Memoized methods (useCallback)
// 6. useImperativeHandle for ref API
// 7. Effect for event setup (runs once)
// 8. Return JSX
```

## File Structure

```
react-cropper-2/
├── src/
│   ├── components/
│   │   ├── Cropper.tsx           # Main component (215 lines)
│   │   └── Cropper.test.tsx      # 25 tests
│   ├── hooks/
│   │   ├── useCropper.ts         # Hook implementation (260 lines)
│   │   └── useCropper.test.ts    # 24 tests
│   ├── types/
│   │   ├── index.ts              # Type definitions
│   │   └── jsx.d.ts              # JSX custom elements
│   └── index.ts                  # Main export
├── tests/
│   └── setup.ts                  # Vitest configuration
├── examples/
│   └── basic/                    # Example app
└── dist/                         # Build output (git ignored)
```

## Dependencies

### Peer Dependencies
- `react`: ^18.0.0
- `react-dom`: ^18.0.0
- `cropperjs`: ^2.0.0 (must be installed by consumer)

### Dev Dependencies
- TypeScript 5.9+
- Vite 5.x
- Vitest 2.x
- ESLint + Prettier

## Known Issues & Limitations

### Fixed Issues
1. ✅ Stale closure bugs in event handlers (fixed with ref pattern)
2. ✅ Race conditions in effect dependencies (fixed with proper deps)
3. ✅ JSX namespace declarations (properly configured)

### Current Limitations
1. No SSR testing (consider adding)
2. No integration tests with real CropperJS
3. No accessibility tests
4. No debouncing option for frequent events
5. No loading state callbacks (onLoad, onError)

## Performance Considerations

### Optimizations Applied
- `useCallback` for stable function references
- `useImperativeHandle` to minimize re-renders
- Event listeners attached once (not re-attached on props change)
- Proper cleanup prevents memory leaks

### Potential Improvements
- Add debouncing option for onChange
- Consider memoization for computed values
- Optimize bounds state updates

## Testing Strategy

### Unit Tests (49 total)
- **Cropper Component:** 25 tests
  - Rendering
  - Props configuration
  - Event handlers
  - Ref methods
  - Edge cases

- **useCropper Hook:** 24 tests
  - Initialization
  - Method testing
  - Event handlers
  - Cleanup
  - Error handling

### Test Helper Pattern
```typescript
// Custom helper for testing hooks with refs
function renderHookWithRefs(options) {
  // Sets refs during render to trigger effects
  // Returns result getter for accessing hook state
}
```

## Build Output

```
dist/
├── index.js       4.55 KB  (ESM)
├── index.cjs      3.17 KB  (CommonJS)
├── index.d.ts     6.9 KB   (TypeScript)
└── *.map                   (Source maps)
```

## Scripts

- `npm run dev` - Start example app (Vite dev server)
- `npm test` - Run tests in watch mode
- `npm run build` - Build library for production
- `npm run typecheck` - TypeScript type checking
- `npm run lint` - ESLint with auto-fix
- `npm run format` - Prettier formatting

## Versioning & Publishing

### Current Status
- Version: 0.1.0
- Status: Production-ready
- License: MIT

### Publishing Checklist
1. ✅ All tests passing
2. ✅ Build successful
3. ✅ TypeScript checks pass
4. ✅ Lint checks pass
5. ✅ Documentation complete
6. ⬜ Update version in package.json
7. ⬜ Create git tag
8. ⬜ npm publish

## Contributing Guidelines

### Code Style
- Follow existing patterns
- Write tests first (TDD)
- Use TypeScript strict mode
- No ESLint warnings
- Format with Prettier

### Commit Conventions
Use Conventional Commits:
- `feat:` - New features
- `fix:` - Bug fixes
- `docs:` - Documentation
- `test:` - Tests
- `refactor:` - Code refactoring
- `chore:` - Tooling/config

### Pull Request Process
1. Create feature branch
2. Write tests
3. Implement feature
4. Ensure all checks pass
5. Update documentation
6. Create PR with description

## Resources

### Related Projects
- [CropperJS](https://github.com/fengyuanchen/cropperjs) - Underlying library
- [react-cropper](https://github.com/react-cropper/react-cropper) - v1 wrapper (inspiration)

### Documentation
- README.md - Overview and features
- QUICK_START.md - Getting started guide
- SETUP_SUMMARY.md - Detailed project structure
- PROJECT_SUMMARY.md - Complete development overview

## Maintenance Notes

### Regular Tasks
- Keep dependencies updated
- Monitor CropperJS 2.x releases
- Respond to issues promptly
- Review and merge PRs

### Future Enhancements
1. Add loading state callbacks
2. Implement debouncing option
3. Add bounds validation
4. Create integration tests
5. Add SSR support tests
6. Improve accessibility
7. Create playground/demo app
8. Add more examples

## Contact & Support

- Issues: GitHub Issues
- Documentation: See docs/ directory
- Examples: See examples/ directory
